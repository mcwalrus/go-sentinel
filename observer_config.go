package sentinel

import (
	_ "context"
	"time"

	"github.com/mcwalrus/go-sentinel/circuit"
	"github.com/mcwalrus/go-sentinel/retry"
	"github.com/prometheus/client_golang/prometheus"
)

// ObserverOption defines prometheus metrics options for an [Observer].
// Options are provided to [NewObserver] on setting up the Observer.
type ObserverOption func(*config)

// config defines the configuration for a [Observer].
type config struct {
	namespace     string
	subsystem     string
	description   string
	buckets       []float64
	constLabels   prometheus.Labels
	trackRetries  bool
	trackTimeouts bool
}

type ObserverConfig struct {
	// Timeout sets a context deadline tasks passed to [Observer.RunFunc].
	// The Observer records timeout occurrences via metrics when enabled.
	Timeout time.Duration

	// MaxRetries specifies the number of retry attempts for tasks on errors.
	// If a task fails for all attempts, the observer groups errors from multiple
	// attempts using [errors.Join]. By default, no retries are performed.
	MaxRetries int

	// RetryStrategy is a handler which returns wait durations between retry attempts.
	// The first call to the handler will provide retryCount at 0. Subsequent calls
	// will increment retryCount. By default, no wait strategy is applied.
	RetryStrategy retry.Strategy

	// RetryBreaker is a handler that skips following retry attempts for a task when
	// returning true. The handler will be provided the error from the previous attempt.
	// When nil, the observer will always attempt the next retry. This is useful to stop
	// retries on particular errors.
	RetryBreaker circuit.Breaker
}

type ObserverControls struct {
	// NewRequestControl prevents new task executions when returning true. This control is
	// checked before each call to Run() or RunFunc(). This is useful to manage avoid new
	// task executions on shutdown signals, or through managed resource limits. By default,
	// new observer requests are always allowed.
	NewRequestControl circuit.Control

	// InFlightControl prevents retry attempts when returning true. This control is checked
	// before each retry attempt for tasks that have failed. This is useful to exit early
	// on shutdown signals. When nil, retries are allowed according to the retry configuration.
	InFlightControl circuit.Control
}

// WithNamespace sets the prometheus namespace for all metrics generated by this observer.
// For example, "myapp" with no subsystem results in metrics like "myapp_success_total".
// If empty with subsystem, no namespace prefix is used.
//
// Example usage:
//
//	observer := sentinel.NewObserver(
//	    sentinel.WithNamespace("myapp"),
//	)
func WithNamespace(namespace string) ObserverOption {
	return func(cfg *config) {
		cfg.namespace = namespace
	}
}

// WithSubsystem sets the prometheus subsystem for all metrics generated by this observer.
// For example, "workers" with no namespace results in metrics like "workers_success_total".
// If empty with namespace, defaults to "sentinel" if not specified.
//
// Example usage:
//
//	observer := sentinel.NewObserver(
//	    sentinel.WithSubsystem("workers"),
//	)
func WithSubsystem(subsystem string) ObserverOption {
	return func(cfg *config) {
		cfg.subsystem = subsystem
	}
}

// WithDescription sets the description used in the help text for generated prometheus
// metrics to describe the tasks being observed. For example, "background processes"
// results in help text like: "Number of successes from observed background processes".
// Defaults to "tasks" to convey a generic process if not specified.
//
// Example usage:
//
//	observer := sentinel.NewObserver(
//	    sentinel.WithDescription("background processes"),
//	)
func WithDescription(description string) ObserverOption {
	return func(cfg *config) {
		cfg.description = description
	}
}

// WithDurationMetrics enables histogram durations metrics for the Observer.
// Buckets are specified in seconds with generated buckets range between 0 and math.Inf.
// For each observed runtime of a task, it is recorded to one of the specified buckets.
// Please refer to [prometheus.HistogramOpts].Buckets for more information.
//
// Example usage:
//
//	observer := sentinel.NewObserver(
//	    sentinel.WithDurationMetrics([]float64{0.05, 1, 5, 30, 600}),
//	)
func WithDurationMetrics(buckets []float64) ObserverOption {
	return func(cfg *config) {
		cfg.buckets = buckets
	}
}

// WithTimeoutMetrics enables timeout-specific prometheus metrics.
// When enabled, a separate "timeouts_total" metric is created to track tasks that
// return [context.DeadlineExceeded] errors. This provides visibility into timeout
// occurrences separate from general errors, allowing for better monitoring of
// timeout-related issues.
//
// Example usage:
//
//	observer := sentinel.NewObserver(
//	    sentinel.WithTimeoutMetrics(),
//	)
func WithTimeoutMetrics() ObserverOption {
	return func(cfg *config) {
		cfg.trackTimeouts = true
	}
}

// WithRetryMetrics enables comprehensive retry observability metrics.
// When enabled, "retries_total" metric is created to provide visibility into retry
// behaviour. Persistent failures across all retries are recorded in "failures_total".
//
// Retry metrics are only recorded when:
// - MaxRetries is set to a value greater than 0 in [ObserverConfig].
// - When a task returns an error and retry attempt is made.
//
// Example usage:
//
//	observer := sentinel.NewObserver(
//	    sentinel.WithRetryMetrics(),
//	)
func WithRetryMetrics() ObserverOption {
	return func(cfg *config) {
		cfg.trackRetries = true
	}
}

// WithConstLabels sets constant labels to exported metrics from the Observer.
// By convention, ConstLabels are not a recommended practice for Prometheus metrics.
// For more information, please refer to [prometheus.Opts].ConstLabels documentation.
//
// Example usage:
//
//	observer := sentinel.NewObserver(
//	    sentinel.WithConstLabels(
//	        prometheus.Labels{"env": "production"},
//	    ),
//	)
func WithConstLabels(labels prometheus.Labels) ObserverOption {
	return func(cfg *config) {
		cfg.constLabels = labels
	}
}
